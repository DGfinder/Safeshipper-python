<!DOCTYPE html>
<html>

<head>
  <title>Search PDF into Google Spreadsheet api</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link rel="stylesheet" media="all" href="{{ url_for('static', filename='fonts/font-awesome/css/font-awesome.min.css')}}">
  <link rel="stylesheet" media="all" href="{{ url_for('static', filename='css/argon-dashboard.css')}}">
  <link rel="stylesheet" media="all" href="{{ url_for('static', filename='dropzone.css')}}">
  <link rel="stylesheet" media="all" href="{{ url_for('static', filename='custom.css')}}">
</head>

<body class="g-sidenav-show bg-gray-100 g-sidenav-hidden">
  {% include 'partials/upper.html' %}

  {% include 'partials/sidebar.html' %}

  <main class="main-content position-relative border-radius-lg">
    {% include 'partials/navbar.html' %}

    <div class="container-fluid py-4">
      <div class="row main-container">
        <div class="col-12">
          <div class="card">
            <div class="card-header p-3">
              <h5 class="mb-2">Compatibility Check</h5>
              <p class="mb-0">See if the dangerous goods on your manifest are compatible.</p>
            </div>
            <div class="card-body p-3">
              <div class="home-container">
                <div class="dropzone-container">
                  <form action="./upload" class="dropzone text-center"></form>
                  <section class="loading-container hidden">
                    <img src="{{ url_for('static', filename='images/dgfinder_loader.svg')}}">
                  </section>
                </div>
              </div>
              <div class="search-container row" style="display: none;">
                <div class="col-md-6 pdf-viewer">
                </div>
                <div class="col-md-6">
                  <div class="table-responsive">
                    <table class="table table-bordered table-striped">
                      <thead>
                        <th>No</th>
                        <th>Un Number</th>
                        <th>Proper Shipping Name</th>
                        <th>Class</th>
                        <th class="compatibility">
                        </th>
                      </thead>
                      <tbody>
                      </tbody>
                    </table>			
                  </div>
                </div>	
              </div>
            </div>
          </div>
        </div>
      </div>

      {% include 'partials/footer.html' %}
    </div>
  </main>

  {% include 'partials/sidenav.html' %}

  <input type="hidden" class="filename" />
  <script src="{{ url_for('static', filename='jquery.min.js')}}"></script>
  <script src="{{ url_for('static', filename='popper.min.js')}}"></script>
  <script src="{{ url_for('static', filename='dropzone.js')}}"></script>
  <script src="{{ url_for('static', filename='js/core/bootstrap.min.js')}}"></script>
  <script src="{{ url_for('static', filename='js/argon-dashboard.js')}}"></script>
  <script>
    let PDFFILE = "";
    $(document).ready(function() {
      $(".dropzone-container form span").html(
        "<div class='pdf-image-wrapper'>" +
        "<img class='commonImage' src='{{ url_for('static', filename='images/frame.png')}}' /></div>" +
        "<button class='btn btn-default btn-upload-document' type='button'>" +
        "<img class='commonImage' src='{{ url_for('static', filename='images/Vector.png')}}'/>" +
        "Upload Hazard Manifest</button><div><div class='drag-drop-desc'><small>or drag and drop</small></div>" +
        "<div class='document-type-desc'><small>(pdf, doc, docx)</small></div></div>"
      );
      Dropzone.options.Dropzone = {
          maxFiles: 1,
          acceptedFiles: "application/pdf",
          addRemoveLinks: true
      };

      $("body").on("click", ".btn-search", function(e) {
	    	e.preventDefault();

	    	let filename = $(".filename").val();
	    	if (filename !== "") {
	    		$(".loading-container").removeClass("hidden");
	    		$(".dropzone-container > form").addClass("hidden");
		    	$(".btn-search .search-loading").show();
		    	$(".btn-search span").text("");
		    	$(".btn-search img").hide();
		    	$(this).attr("disabled", "disabled");

          let data = {"filename": filename};
	    		$.ajax({
	    			url: 'search-compatibility',
            data: JSON.stringify(data),
            contentType: "application/json",
	    			dataType: "json",
	    			type: "POST",
	    			success:function(response) {
	    				$(".pdf-viewer").html("<iframe src=" + response[3] + "></iframe>")
	    				let classes = response[2];
	    				let th_compatibility = "";
	    				for (let i = 0; i < Object.keys(classes).length; i++) {
	    					th_compatibility += "<span>" + classes[i] + "</span>";
	    				}
	    				$("th.compatibility").html("<div>" + th_compatibility + "</div>");
    					$(".home-container").hide();
    					$(".search-container").show();
	    				$(".loading-container").addClass("hidden");
    					$(".dropzone-container > form").addClass("hidden");
	    				$(".btn-search .search-loading").hide();
    					$(".btn-search").removeAttr("disabled");
		    			$(".btn-search span").text("Search");
		    			$(".btn-search img").show();

              let search_tbody_str = "";
	    				if (response[0].length > 0) {
                let list = response[0];
                for (let i = 0; i < list.length; i++) {
                  let compatible_str = "";
                  let compatibilities = list[i][list[i].length - 2].split(", ");
                  let incompatibilities = list[i][list[i].length - 1].split(", ");
                  for (let j = 0; j < Object.keys(classes).length; j++) {
                    let compatible_class = classes[j].replace( /\s*(?:\[[^\]]*\]|\([^)]*\))\s*/g, "" );
                    if (compatibilities.includes(compatible_class)) {
                      compatible_str += "<span><div class=\"green circle\"></div></span>";
                    }
                    if (incompatibilities.includes(compatible_class)) {
                      compatible_str += "<span><div class=\"red circle\"></div></span>";
                    }
                    if (!compatibilities.includes(compatible_class) && !incompatibilities.includes(compatible_class)) {
                      compatible_str += "<span></span>";
                    }

                  }
                  search_tbody_str += "<tr><td>" + (i + 1).toString() + "</td><td>" + list[i][1] + "</td><td>" +
                    list[i][2] + "</td><td>" + list[i][4] + "</td><td class=\"compatibility\"><div>" +
                    compatible_str + "</div></td></tr>";
                }
	    				} else {
	    					search_tbody_str = "<tr><td colspan=\"5\">No matched keywords</td></tr>";
	    				}
						  $(".search-container tbody").html(search_tbody_str);
	    			}
	    		});
	    	} else {
	    		alert("No file uploaded.");
	    	}
	    });
    });
  </script>
</body>

</html>